<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pencarian Data VKRN</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        body {
            background: #181818;
            color: #fff;
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
        }
        .container {
            max-width: 600px;
            margin: 40px auto;
            background: #222;
            border-radius: 12px;
            box-shadow: 0 6px 32px rgba(0,0,0,0.2);
            padding: 32px 24px 24px 24px;
        }
        h1 {
            color: #FFD700;
            text-align: center;
            margin-bottom: 16px;
        }
        .refresh-index-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 16px;
        }
        #refreshIndexBtn {
            background: #FFD700;
            color: #181818;
            border: none;
            border-radius: 50%;
            width: 56px;height: 56px;
            font-size: 32px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.14);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            transition: box-shadow 0.2s, background 0.2s;
        }
        #refreshIndexBtn:hover {
            background: #fff;
            color: #FFD700;
            box-shadow: 0 4px 14px rgba(255,215,0,0.12);
        }
        .refresh-index-text {
            color: #fff;
            font-size: 18px;
            text-align: center;
            margin-bottom: 8px;
            font-weight: 500;
            text-shadow: 0 2px 8px #FFD70033;
        }
        .system-status {
            margin: 0 auto 18px auto;
            text-align: center;
            color: #FFD700;
            font-size: 16px;
            padding: 10px;
            background: #222;
            border-radius: 8px;
            border: 1px solid #FFD700;
            box-shadow: 0 2px 8px #FFD70022;
        }
        .error { color: #ff6565; border-color: #ff6565;}
        .search-container input, .search-container button {
            border-radius: 8px;
            border: none;
            padding: 10px;
            margin: 0 4px 0 0;
            font-size: 16px;
        }
        .search-container input {
            width: 65%;
            background: #fff;
            color: #222;
        }
        .search-container button {
            background: #FFD700;
            color: #181818;
            cursor: pointer;
            font-weight: bold;
        }
        .result-item {
            border: 2px solid #FFD700;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 15px;
            background: #181818;
            box-shadow: 0 2px 12px #FFD70012;
            color: #fff;
        }
        .result-item .show-program-btn {
            background: #FFD700;
            color: #181818;
            border-radius: 8px;
            border: none;
            padding: 8px 16px;
            margin-top: 8px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 2px 8px #FFD70033;
        }
        .initialization-overlay {
            display: none;
            position: fixed;
            top:0; left:0; width:100vw; height:100vh;
            background: rgba(24,24,24,0.98);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .initialization-content {
            background: #222;
            border-radius: 16px;
            padding: 40px 32px 32px 32px;
            box-shadow: 0 8px 40px #FFD70044;
            text-align: center;
            color: #FFD700;
            width: 350px;
        }
        .init-spinner {
            margin: 0 auto 22px auto;
            width: 56px;
            height: 56px;
            border: 6px solid #FFD700;
            border-top: 6px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .init-text {
            font-size: 22px;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 10px;
        }
        .init-subtext {
            font-size: 16px;
            color: #fff;
            margin-bottom: 22px;
        }
        .progress-bar {
            width: 100%;
            height: 16px;
            background: #fff;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 14px;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #FFD700 65%, #fff 100%);
            transition: width 0.3s;
        }
        .progress-text {
            color: #FFD700;
            font-size: 16px;
        }
        .search-again-container { display:none; }
        .search-again-container.show { display:block;}
        .search-container.hidden { display:none; }
        .no-results {
            color: #FFD700;
            text-align: center;
            margin-top: 22px;
            font-size: 18px;
        }
        .results-count {
            color: #FFD700;
            margin-bottom: 12px;
        }
        .pdf-page {
            margin: 24px 0;
            border-radius: 12px;
            box-shadow: 0 2px 12px #FFD70033;
            background: #222;
            padding: 8px;
        }
        .pdf-canvas {
            border-radius: 8px;
            background: #fff;
            display: block;
            margin: 0 auto;
        }
        .highlight-overlay {
            position: absolute;
            background: rgba(255, 215, 0, 0.6);
            border-radius: 4px;
            pointer-events: none;
            z-index: 2;
        }
        .error-message {
            color: #ff6565;
            text-align: center;
            font-size: 18px;
            margin-top: 18px;
            background: #222;
            border-radius: 8px;
            padding: 12px;
            border: 1px solid #ff6565;
        }
    </style>
</head>
<body>
    <!-- Overlay indexing -->
    <div class="initialization-overlay" id="initOverlay">
        <div class="initialization-content">
            <div class="init-spinner"></div>
            <div class="init-text">Indexing PDF Data...</div>
            <div class="init-subtext" id="initSubtext">Sedang mengindex file PDF, mohon tunggu beberapa saat.</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">0% - Memuat...</div>
        </div>
    </div>
    <div class="container">
        <h1>Pencarian Data VKRN</h1>
        <!-- Refresh index icon & text -->
        <div class="refresh-index-wrapper" id="refreshIndexWrapper" style="display:none;">
            <button id="refreshIndexBtn" title="Refresh Index">üîÑ</button>
            <div class="refresh-index-text">Klik untuk memulai indexing data</div>
        </div>
        <div class="system-status show error" id="systemStatus">
            ‚ö†Ô∏è Sistem belum di-index.
        </div>
        <!-- Search -->
        <div class="search-container" id="searchContainer">
            <input type="text" id="searchInput" placeholder="Masukkan kata kunci pencarian...">
            <button id="searchButton">Cari</button>
        </div>
        <div class="search-again-container" id="searchAgainContainer">
            <button class="search-again-btn" id="searchAgainBtn">üîç Cari Lagi</button>
        </div>
        <div id="resultsContainer"></div>
        <div id="pdfContainer" style="display:none;">
            <div class="pdf-viewer" id="pdfViewer"></div>
        </div>
    </div>
    <script>
        // Variabel global
        let csvData = [];
        let currentPdf = null;
        let searchIdpel = '';
        let foundPages = [];
        let devicePixelRatio = window.devicePixelRatio || 1;
        let hasSearchResults = false;
        let pdfDatabase = new Map(); // Menyimpan objek PDF yang sudah dimuat
        let textIndex = new Map(); // Index teks dari semua PDF
        let pageCache = new Map(); // Cache halaman yang sudah di-render
        let isSystemReady = false;
        // Daftar file PDF yang tersedia (ubah sesuai kebutuhan Anda)
        const availablePDFs = [
            { file: 'pdf/CR_PK_TOKEN_LPB_kolektif-KRN KEJAJAR.pdf', name: 'CR PK TOKEN LPB Kolektif KRN KEJAJAR', id: 'pdf1' },
            { file: 'pdf/KRN KEJAJAR.pdf', name: 'KRN KEJAJAR', id: 'pdf2' },
            { file: 'pdf/KRN KEJAJAR160824.PDF', name: 'KRN KEJAJAR 160824', id: 'pdf3' },
            { file: 'pdf/TOKEN JAMAL 160824.pdf', name: 'TOKEN JAMAL 160824', id: 'pdf4' }
        ];
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        function updateProgress(percentage, text) {
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = `${percentage}% - ${text}`;
        }
        function showSystemStatus(message, isError = false) {
            const systemStatus = document.getElementById('systemStatus');
            systemStatus.textContent = message;
            systemStatus.className = isError ? 'system-status show error' : 'system-status show';
            if (!isError) {
                setTimeout(() => { systemStatus.classList.remove('show'); }, 5000);
            }
        }
        // --- Check cache index on load ---
        function checkIndexCache() {
            if (loadIndexFromStorage()) {
                isSystemReady = true;
                document.getElementById('refreshIndexWrapper').style.display = "none";
                showSystemStatus(`‚úÖ Sistem siap! Database PDF sudah diindex.`);
            } else {
                isSystemReady = false;
                document.getElementById('refreshIndexWrapper').style.display = "flex";
                showSystemStatus('‚ö†Ô∏è Sistem belum di-index. Silakan klik tombol di bawah untuk memulai indexing data.', true);
            }
        }
        // --- Overlay indexing khusus PDF ---
        async function initializeSystem() {
            document.getElementById('initOverlay').style.display = 'flex';
            document.getElementById('initSubtext').textContent = "Sedang mengindex file PDF, mohon tunggu beberapa saat.";
            updateProgress(5, 'Indexing PDF...');
            try {
                let totalProgress = 0;
                const progressPerPDF = 90 / availablePDFs.length;
                for (let i = 0; i < availablePDFs.length; i++) {
                    const pdfInfo = availablePDFs[i];
                    updateProgress(10 + (i * progressPerPDF), `Memuat ${pdfInfo.name}...`);
                    try {
                        const loadingTask = pdfjsLib.getDocument(pdfInfo.file);
                        const pdf = await loadingTask.promise;
                        pdfDatabase.set(pdfInfo.id, { pdf: pdf, info: pdfInfo, totalPages: pdf.numPages });
                        updateProgress(10 + (i * progressPerPDF) + (progressPerPDF * 0.3), `Mengindex teks ${pdfInfo.name}...`);
                        await indexPDFText(pdf, pdfInfo);
                        updateProgress(10 + ((i + 1) * progressPerPDF), `Selesai memuat ${pdfInfo.name}`);
                    } catch (error) { console.error(`Error loading ${pdfInfo.file}:`, error); }
                }
                updateProgress(100, 'Sistem siap!');
                await saveIndexToStorage();
                setTimeout(() => {
                    document.getElementById('initOverlay').style.display = 'none';
                    isSystemReady = true;
                    document.getElementById('refreshIndexWrapper').style.display = "none";
                    showSystemStatus(`‚úÖ Sistem siap! Database PDF sudah diindex.`);
                }, 1000);
            } catch (error) {
                updateProgress(100, 'Error Inisialisasi');
                setTimeout(() => {
                    document.getElementById('initOverlay').style.display = 'none';
                    showSystemStatus('‚ùå Error indexing PDF.', true);
                }, 2000);
            }
        }
        async function indexPDFText(pdf, pdfInfo) {
            const totalPages = pdf.numPages;
            for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
                try {
                    const page = await pdf.getPage(pageNum);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    const indexKey = `${pdfInfo.id}_page_${pageNum}`;
                    textIndex.set(indexKey, { pdfId: pdfInfo.id, pdfInfo: pdfInfo, pageNumber: pageNum, text: pageText.toLowerCase(), originalText: pageText, textItems: textContent.items });
                } catch (error) {
                    console.error(`Error indexing page ${pageNum} of ${pdfInfo.name}:`, error);
                }
            }
        }
        async function saveIndexToStorage() {
            try {
                const indexData = {};
                let count = 0;
                for (const [key, value] of textIndex.entries()) {
                    indexData[key] = { pdfId: value.pdfId, pageNumber: value.pageNumber, text: value.text, originalText: value.originalText };
                    count++;
                    if (count > 1000) break;
                }
                localStorage.setItem('vkrn_text_index', JSON.stringify({ data: indexData, timestamp: Date.now(), version: '1.0' }));
            } catch (error) {
                console.warn('Gagal menyimpan index ke localStorage:', error);
            }
        }
        function loadIndexFromStorage() {
            try {
                const stored = localStorage.getItem('vkrn_text_index');
                if (stored) {
                    const parsed = JSON.parse(stored);
                    const age = Date.now() - parsed.timestamp;
                    if (age < 7 * 24 * 60 * 60 * 1000) {
                        for (const [key, value] of Object.entries(parsed.data)) {
                            textIndex.set(key, value);
                        }
                        return true;
                    }
                }
            } catch (error) {
                console.warn('Gagal memuat index dari localStorage:', error);
            }
            return false;
        }
        function instantSearch(searchTerm) {
            const results = [];
            const searchTermLower = searchTerm.toLowerCase();
            for (const [key, indexEntry] of textIndex.entries()) {
                if (indexEntry.text.includes(searchTermLower)) {
                    results.push(indexEntry);
                }
            }
            return results;
        }
        async function loadCSVData() {
            try {
                const response = await fetch('vkrn.csv');
                const csvText = await response.text();
                const lines = csvText.split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                for (let i = 1; i < lines.length; i++) {
                    const currentLine = lines[i].split(',');
                    if (currentLine.length === headers.length && currentLine[0].trim() !== '') {
                        const obj = {};
                        for (let j = 0; j < headers.length; j++) {
                            obj[headers[j]] = currentLine[j].trim();
                        }
                        csvData.push(obj);
                    }
                }
            } catch (error) {
                console.error('Gagal memuat file CSV:', error);
                throw error;
            }
        }
        function toggleSearchDisplay(showResults = false) {
            const searchContainer = document.getElementById('searchContainer');
            const searchAgainContainer = document.getElementById('searchAgainContainer');
            if (showResults) {
                searchContainer.classList.add('hidden');
                searchAgainContainer.classList.add('show');
                hasSearchResults = true;
            } else {
                searchContainer.classList.remove('hidden');
                searchAgainContainer.classList.remove('show');
                hasSearchResults = false;
            }
        }
        function searchAgain() {
            toggleSearchDisplay(false);
            document.getElementById('resultsContainer').innerHTML = '';
            document.getElementById('pdfContainer').style.display = 'none';
            document.getElementById('searchInput').value = '';
            document.getElementById('searchInput').focus();
        }
        function performSearch(keyword) {
            if (keyword.trim() === "") {
                alert('Silakan masukkan kata kunci pencarian');
                return;
            }
            if (!isSystemReady) {
                alert('Sistem masih dalam proses inisialisasi. Mohon tunggu sebentar...');
                return;
            }
            document.getElementById('searchInput').value = '';
            document.getElementById('searchInput').blur();
            keyword = keyword.toLowerCase();
            const results = csvData.filter(item => {
                for (const key in item) {
                    if (item[key].toLowerCase().includes(keyword)) {
                        return true;
                    }
                }
                return false;
            });
            displayResults(results);
            if (results.length > 0) {
                toggleSearchDisplay(true);
            }
        }
        function displayResults(results) {
            const resultsContainer = document.getElementById('resultsContainer');
            if (results.length === 0) {
                resultsContainer.innerHTML = '<div class="no-results">Tidak ditemukan data yang sesuai</div>';
                document.getElementById('pdfContainer').style.display = 'none';
                return;
            }
            let html = `<div class="results-count">üìä Ditemukan ${results.length} data:</div>`;
            results.forEach((item, index) => {
                html += '<div class="result-item">';
                for (const key in item) {
                    if (key === 'IDPEL') {
                        html += `<div class="idpel"><strong>${key}:</strong> ${item[key]}</div>`;
                    } else {
                        html += `<p><strong>${key}:</strong> ${item[key]}</p>`;
                    }
                }
                if (item.IDPEL && item.IDPEL.trim() !== '') {
                    html += `<button class="show-program-btn instant" onclick="showProgram('${item.IDPEL}')">üìÑ Tampilkan Program (Instan)<br>IDPEL: ${item.IDPEL}</button>`;
                }
                html += '</div>';
            });
            resultsContainer.innerHTML = html;
        }
        async function showProgram(idpel) {
            const pdfContainer = document.getElementById('pdfContainer');
            const pdfViewer = document.getElementById('pdfViewer');
            if (!isSystemReady) {
                alert('Sistem masih dalam proses inisialisasi. Mohon tunggu sebentar...');
                return;
            }
            searchIdpel = idpel;
            pdfContainer.style.display = 'block';
            pdfContainer.scrollIntoView({ behavior: 'smooth' });
            const searchResults = instantSearch(idpel);
            if (searchResults.length === 0) {
                pdfViewer.innerHTML = `<div class="error-message">üîç IDPEL "${idpel}" tidak ditemukan dalam database PDF</div>`;
                return;
            }
            pdfViewer.innerHTML = '<div style="text-align: center; padding: 20px; color: #FFD700;">‚ö° Memuat hasil pencarian instan...</div>';
            await renderFoundPages(searchResults);
        }
        async function renderFoundPages(searchResults) {
            const pdfViewer = document.getElementById('pdfViewer');
            pdfViewer.innerHTML = '';
            const groupedResults = new Map();
            for (const result of searchResults) {
                if (!groupedResults.has(result.pdfId)) {
                    groupedResults.set(result.pdfId, []);
                }
                groupedResults.get(result.pdfId).push(result);
            }
            for (const [pdfId, pages] of groupedResults.entries()) {
                const pdfData = pdfDatabase.get(pdfId);
                if (!pdfData) continue;
                for (const pageResult of pages) {
                    try {
                        const page = await pdfData.pdf.getPage(pageResult.pageNumber);
                        const containerWidth = pdfViewer.clientWidth - 40;
                        const baseViewport = page.getViewport({ scale: 1 });
                        const scale = containerWidth / baseViewport.width;
                        const pageDiv = document.createElement('div');
                        pageDiv.className = 'pdf-page';
                        pageDiv.style.position = 'relative';
                        const canvas = await renderPageToCanvas(page, scale);
                        pageDiv.appendChild(canvas);
                        await highlightTextInPage(page, pageDiv, page.getViewport({ scale: scale }), searchIdpel);
                        pdfViewer.appendChild(pageDiv);
                    } catch (error) {
                        console.error(`Error rendering page ${pageResult.pageNumber}:`, error);
                    }
                }
            }
        }
        async function renderPageToCanvas(page, scale) {
            const scaledViewport = page.getViewport({ scale: scale });
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            const outputScale = devicePixelRatio;
            canvas.width = Math.floor(scaledViewport.width * outputScale);
            canvas.height = Math.floor(scaledViewport.height * outputScale);
            canvas.style.width = Math.floor(scaledViewport.width) + "px";
            canvas.style.height = Math.floor(scaledViewport.height) + "px";
            const transform = outputScale !== 1 ? [outputScale, 0, 0, outputScale, 0, 0] : null;
            context.imageSmoothingEnabled = true;
            context.imageSmoothingQuality = 'high';
            canvas.className = 'pdf-canvas';
            const renderContext = {
                canvasContext: context,
                viewport: scaledViewport,
                transform: transform
            };
            await page.render(renderContext).promise;
            return canvas;
        }
        async function highlightTextInPage(page, pageDiv, viewport, searchText) {
            try {
                const textContent = await page.getTextContent();
                textContent.items.forEach(item => {
                    if (item.str.toLowerCase().includes(searchText.toLowerCase())) {
                        const highlight = document.createElement('div');
                        highlight.className = 'highlight-overlay';
                        const transform = pdfjsLib.Util.transform(viewport.transform, item.transform);
                        const left = transform[4];
                        const top = viewport.height - transform[5] - item.height;
                        highlight.style.left = left + 'px';
                        highlight.style.top = top + 'px';
                        highlight.style.width = item.width + 'px';
                        highlight.style.height = item.height + 'px';
                        pageDiv.appendChild(highlight);
                    }
                });
            } catch (error) {
                console.error('Error highlighting text:', error);
            }
        }
        document.addEventListener('DOMContentLoaded', async () => {
            checkIndexCache();
            await loadCSVData();
            document.getElementById('searchButton').addEventListener('click', () => {
                const keyword = document.getElementById('searchInput').value;
                performSearch(keyword);
            });
            document.getElementById('searchInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const keyword = document.getElementById('searchInput').value;
                    performSearch(keyword);
                }
            });
            document.getElementById('searchAgainBtn').addEventListener('click', searchAgain);
            document.getElementById('refreshIndexBtn').addEventListener('click', () => {
                initializeSystem();
            });
        });
    </script>
</body>
    </html>
