<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Pencarian Data VKRN</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        body { margin: 0; padding: 20px; background: #f5f5f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .container { max-width: 700px; margin: 0 auto; background: #fff; padding: 32px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);}
        h1 { text-align: center; color: #2c3e50; margin-bottom: 30px;}
        form { display: flex; flex-direction: row; gap: 16px; margin-bottom: 24px;}
        input[type="text"] { flex:1; padding: 8px; border: 1px solid #ccc; border-radius: 6px;}
        button { padding: 10px 18px; background: #2980b9; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;}
        button:hover { background: #3498db;}
        #csvResults, #pdfViewer { margin-top: 24px; }
        .result-row { padding: 10px; border-bottom: 1px solid #eee; }
        .result-row button { margin-left: 20px; }
        .pdf-page { margin-bottom: 24px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Pencarian Data VKRN</h1>
        <form id="searchForm" autocomplete="off">
            <input type="text" id="searchText" placeholder="Cari nama/no_induk/kata..." required>
            <button type="submit">Cari</button>
        </form>
        <div id="csvResults"></div>
        <div id="pdfViewer"></div>
    </div>

    <script>
        const pdfjsLib = window['pdfjs-dist/build/pdf'];
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // Fungsi parsing CSV
        async function fetchCSV(url) {
            const response = await fetch(url);
            const text = await response.text();
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',');
            const rows = lines.slice(1).map(line => {
                const values = line.split(',');
                let obj = {};
                headers.forEach((h, i) => obj[h.trim()] = values[i]?.trim());
                return obj;
            });
            return rows;
        }

        // Fungsi PDF Viewer
        async function showPDF(pdfUrl) {
            const viewerDiv = document.getElementById('pdfViewer');
            viewerDiv.innerHTML = "<em>Memuat PDF...</em>";
            try {
                const loadingTask = pdfjsLib.getDocument(pdfUrl);
                const pdf = await loadingTask.promise;
                let html = '';
                for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                    const page = await pdf.getPage(pageNum);
                    const viewport = page.getViewport({ scale: 1 });
                    const canvas = document.createElement("canvas");
                    canvas.className = "pdf-page";
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    const context = canvas.getContext("2d");
                    await page.render({ canvasContext: context, viewport: viewport }).promise;
                    html += `<div class="pdf-page"><b>Halaman ${pageNum}</b><br/>${canvas.outerHTML}</div>`;
                }
                viewerDiv.innerHTML = html;
            } catch (err) {
                viewerDiv.innerHTML = `<span style="color:red;">Gagal memuat PDF: ${pdfUrl}</span>`;
            }
        }

        // Event pencarian
        document.getElementById('searchForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const searchText = document.getElementById('searchText').value.trim().toLowerCase();
            const csvResultsDiv = document.getElementById('csvResults');
            const pdfViewerDiv = document.getElementById('pdfViewer');
            csvResultsDiv.innerHTML = '<em>Mencari di CSV...</em>';
            pdfViewerDiv.innerHTML = '';

            // Ambil dan filter data CSV
            const csvData = await fetchCSV('vkrn.csv');
            const filtered = csvData.filter(row =>
                Object.values(row).some(v => v && v.toLowerCase().includes(searchText))
            );

            if (filtered.length === 0) {
                csvResultsDiv.innerHTML = '<em>Tidak ditemukan di CSV.</em>';
                return;
            }

            // Tampilkan hasil, buat tombol lihat PDF
            let csvHtml = '<b>Hasil pencarian:</b>';
            filtered.forEach((row, idx) => {
                csvHtml += `<div class="result-row">
                    Nama: ${row.nama || ''}, No Induk: ${row.no_induk || ''}, File PDF: ${row.pdf_file || ''}
                    ${row.pdf_file ? `<button onclick="showPDF('${row.pdf_file}')">Lihat</button>` : ''}
                </div>`;
            });
            csvResultsDiv.innerHTML = csvHtml;
        });

        // Agar fungsi showPDF bisa dipanggil dari tombol yang dibuat dinamis
        window.showPDF = showPDF;
    </script>
</body>
</html>
