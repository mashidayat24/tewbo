<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VKRN ULP Wonosobo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; margin: 0; padding: 20px; }
        .container { max-width: 100%; background: #fff; border-radius: 10px; box-shadow: 0 2px 10px #0001; padding: 30px; margin: 0 auto; }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 30px; }
        .database-controls { text-align: center; margin-bottom: 20px; background: #f8f9fa; border-radius: 4px; padding: 15px; display: block; }
        .database-info { font-size: 13px; color: #6c757d; margin-bottom: 10px; }
        .refresh-db-btn { background: #6c757d; color: #fff; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 13px; }
        .refresh-db-btn:hover { background: #545b62; }
        .system-status { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 12px 15px; border-radius: 4px; margin-bottom: 20px; font-size: 14px; display: none; }
        .system-status.show { display: block; }
        .system-status.error { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .system-status.cached { background: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        .initialization-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #0008; display: none; align-items: center; justify-content: center; z-index: 9999; }
        .initialization-content { background: #fff; padding: 40px; border-radius: 10px; text-align: center; max-width: 450px; width: 90%; }
        .init-spinner { width: 60px; height: 60px; border: 5px solid #ecf0f1; border-top: 5px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
        .init-text { font-size: 18px; font-weight: bold; color: #2c3e50; margin-bottom: 10px; }
        .init-subtext { font-size: 14px; color: #7f8c8d; margin-bottom: 20px; }
        .progress-bar { width: 100%; height: 10px; background: #ecf0f1; border-radius: 5px; overflow: hidden; margin-bottom: 10px; }
        .progress-fill { height: 100%; background: #3498db; width: 0%; transition: width 0.3s ease; }
        .progress-text { font-size: 12px; color: #7f8c8d; }
        .first-time-notice { background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 15px; margin-bottom: 20px; font-size: 13px; color: #856404; display: none; }
        .search-container { display: flex; margin-bottom: 20px; max-width: 800px; margin-left: auto; margin-right: auto; }
        #searchInput { flex: 1; padding: 12px 15px; border: 1px solid #ddd; border-radius: 5px 0 0 5px; font-size: 16px; outline: none; }
        #searchInput:focus { border-color: #3498db; }
        #searchButton { padding: 12px 20px; background: #3498db; color: #fff; border: none; border-radius: 0 5px 5px 0; cursor: pointer; font-size: 16px; }
        #searchButton:hover { background: #2980b9; }
        #resultsContainer { margin-top: 20px; margin-bottom: 30px; }
        .result-item { padding: 15px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 15px; background: #fafafa; }
        .no-results { text-align: center; color: #7f8c8d; padding: 20px; }
        @media (max-width: 768px) { .container { padding: 15px; } }
    </style>
</head>
<body>
    <div class="initialization-overlay" id="initOverlay">
        <div class="initialization-content">
            <div class="init-spinner"></div>
            <div class="init-text" id="initTitle">Memuat Sistem Pencarian</div>
            <div class="init-subtext" id="initSubtext">Mohon tunggu...</div>
            <div class="first-time-notice" id="firstTimeNotice">
                üìù <strong>Informasi:</strong> Database belum tersedia. Klik "Refresh Database" untuk membangun data pencarian.
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">0% - Memuat...</div>
        </div>
    </div>
    <div class="container">
        <h1>VKRN ULP Wonosobo</h1>
        <div class="system-status" id="systemStatus">‚úÖ Sistem siap!</div>
        <div class="database-controls" id="databaseControls">
            <div class="database-info" id="databaseInfo">Database terakhir diupdate: <span id="lastUpdate">-</span></div>
            <button class="refresh-db-btn" id="refreshDbBtn">üîÑ Refresh Database</button>
        </div>
        <div class="search-container" id="searchContainer">
            <input type="text" id="searchInput" placeholder="Masukkan pencarian...">
            <button id="searchButton">Cari</button>
        </div>
        <div id="resultsContainer"></div>
    </div>
    <script>
        // GLOBALS
        let csvData = [];
        let isSystemReady = false;
        let db = null;
        let textIndex = new Map();
        const DATABASE_NAME = 'VKRNPDFDatabase';
        const DATABASE_VERSION = 1;
        const DATABASE_STORE_NAME = 'pdfTextIndex';
        const DATABASE_EXPIRY_DAYS = 30;
        const availablePDFs = [
            { file: 'pdf/CR_PK_TOKEN_LPB_kolektif-KRN KEJAJAR.pdf', name: 'CR PK TOKEN LPB Kolektif KRN KEJAJAR', id: 'pdf1' },
            { file: 'pdf/KRN KEJAJAR.pdf', name: 'KRN KEJAJAR', id: 'pdf2' }
        ];

        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // IndexedDB
        function openDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DATABASE_NAME, DATABASE_VERSION);
                request.onerror = () => reject(request.error);
                request.onsuccess = (event) => { db = event.target.result; resolve(db); };
                request.onupgradeneeded = (event) => {
                    const database = event.target.result;
                    if (database.objectStoreNames.contains(DATABASE_STORE_NAME)) {
                        database.deleteObjectStore(DATABASE_STORE_NAME);
                    }
                    const objectStore = database.createObjectStore(DATABASE_STORE_NAME, { keyPath: 'id', autoIncrement: true });
                    objectStore.createIndex('pdfId', 'pdfId', { unique: false });
                    objectStore.createIndex('searchText', 'searchText', { unique: false });
                };
            });
        }

        async function saveIndexToDatabase(indexData) {
            return new Promise((resolve, reject) => {
                if (!db) return reject(new Error('Database not initialized'));
                const transaction = db.transaction([DATABASE_STORE_NAME], 'readwrite');
                const objectStore = transaction.objectStore(DATABASE_STORE_NAME);
                objectStore.clear().onsuccess = () => {
                    objectStore.add({
                        type: 'metadata',
                        timestamp: Date.now(),
                        version: DATABASE_VERSION,
                        totalPDFs: availablePDFs.length,
                        totalPages: indexData.size
                    });
                    let promises = [];
                    for (const [key, value] of indexData.entries()) {
                        const request = objectStore.add({
                            type: 'index',
                            indexKey: key,
                            pdfId: value.pdfId,
                            pdfInfo: value.pdfInfo,
                            pageNumber: value.pageNumber,
                            searchText: value.text,
                            originalText: value.originalText
                        });
                        promises.push(new Promise(res => request.onsuccess = res));
                    }
                    Promise.all(promises).then(() => resolve());
                };
            });
        }

        async function loadIndexFromDatabase() {
            return new Promise((resolve, reject) => {
                if (!db) return reject(new Error('Database not initialized'));
                const transaction = db.transaction([DATABASE_STORE_NAME], 'readonly');
                const objectStore = transaction.objectStore(DATABASE_STORE_NAME);
                const getAllRequest = objectStore.getAll();
                getAllRequest.onsuccess = () => {
                    const allData = getAllRequest.result;
                    const metadata = allData.find(item => item.type === 'metadata');
                    if (!metadata) return resolve(false);
                    const age = Date.now() - metadata.timestamp;
                    const maxAge = DATABASE_EXPIRY_DAYS * 24 * 60 * 60 * 1000;
                    if (age > maxAge) return resolve(false);
                    const indexData = allData.filter(item => item.type === 'index');
                    textIndex.clear();
                    for (const item of indexData) {
                        textIndex.set(item.indexKey, {
                            pdfId: item.pdfId,
                            pdfInfo: item.pdfInfo,
                            pageNumber: item.pageNumber,
                            text: item.searchText,
                            originalText: item.originalText
                        });
                    }
                    updateDatabaseInfo(metadata.timestamp);
                    resolve(true);
                };
            });
        }

        function updateDatabaseInfo(timestamp) {
            const lastUpdateElement = document.getElementById('lastUpdate');
            if (timestamp) {
                const date = new Date(timestamp);
                lastUpdateElement.textContent = date.toLocaleString('id-ID');
            }
        }

        function updateProgress(percentage, text) {
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = `${percentage}% - ${text}`;
        }

        function showSystemStatus(message, type = 'success') {
            const systemStatus = document.getElementById('systemStatus');
            systemStatus.textContent = message;
            systemStatus.className = 'system-status show';
            if (type === 'error') systemStatus.classList.add('error');
            else if (type === 'cached') systemStatus.classList.add('cached');
            if (type !== 'error') setTimeout(() => systemStatus.classList.remove('show'), 5000);
        }

        async function initializeSystem() {
            document.getElementById('databaseControls').style.display = 'block';
            document.getElementById('initOverlay').style.display = 'flex';
            document.getElementById('firstTimeNotice').style.display = 'none';
            updateProgress(5, 'Membuka database lokal...');
            await openDatabase();
            updateProgress(10, 'Memeriksa database lokal...');
            const hasValidCache = await loadIndexFromDatabase();
            if (hasValidCache) {
                document.getElementById('initTitle').textContent = 'Memuat dari Database Lokal';
                document.getElementById('initSubtext').textContent = 'Menggunakan data yang sudah tersimpan...';
                updateProgress(80, 'Mempersiapkan sistem...');
                await new Promise(res => setTimeout(res, 500));
                updateProgress(100, 'Sistem siap!');
                setTimeout(() => {
                    document.getElementById('initOverlay').style.display = 'none';
                    isSystemReady = true;
                    showSystemStatus(`‚ö° Sistem siap! Menggunakan database lokal dengan ${textIndex.size} entri pencarian.`, 'cached');
                }, 1000);
            } else {
                document.getElementById('initTitle').textContent = 'Database belum tersedia';
                document.getElementById('initSubtext').textContent = 'Klik tombol "Refresh Database" untuk membangun data pencarian.';
                document.getElementById('firstTimeNotice').style.display = 'block';
                updateProgress(0, 'Menunggu refresh database...');
            }
        }

        async function performFullIndexing() {
            updateProgress(10, 'Memuat data CSV...');
            await loadCSVData();
            let progressPerPDF = 75 / availablePDFs.length;
            for (let i = 0; i < availablePDFs.length; i++) {
                const pdfInfo = availablePDFs[i];
                updateProgress(20 + (i * progressPerPDF), `Mengindex ${pdfInfo.name}...`);
                try {
                    const loadingTask = pdfjsLib.getDocument(pdfInfo.file);
                    const pdf = await loadingTask.promise;
                    await indexPDFText(pdf, pdfInfo);
                } catch (error) { }
            }
            updateProgress(95, 'Menyimpan ke database...');
            await saveIndexToDatabase(textIndex);
            updateDatabaseInfo(Date.now());
            updateProgress(100, 'Sistem siap!');
            setTimeout(() => {
                document.getElementById('initOverlay').style.display = 'none';
                isSystemReady = true;
                showSystemStatus(`‚úÖ Sistem siap! Database lokal berisi ${textIndex.size} entri pencarian dari ${availablePDFs.length} file PDF.`);
            }, 1000);
        }

        async function indexPDFText(pdf, pdfInfo) {
            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                const page = await pdf.getPage(pageNum);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                const indexKey = `${pdfInfo.id}_page_${pageNum}`;
                textIndex.set(indexKey, {
                    pdfId: pdfInfo.id,
                    pdfInfo: pdfInfo,
                    pageNumber: pageNum,
                    text: pageText.toLowerCase(),
                    originalText: pageText,
                    textItems: textContent.items
                });
            }
        }

        async function refreshDatabase() {
            if (!confirm('Refresh database? Proses ini akan memakan waktu beberapa menit.')) return;
            document.getElementById('initOverlay').style.display = 'flex';
            document.getElementById('initTitle').textContent = 'Me-refresh Database';
            document.getElementById('initSubtext').textContent = 'Membangun ulang database lokal...';
            document.getElementById('firstTimeNotice').style.display = 'none';
            isSystemReady = false;
            textIndex.clear();
            await performFullIndexing();
        }

        function instantSearch(searchTerm) {
            const results = [];
            const searchTermLower = searchTerm.toLowerCase();
            for (const [key, indexEntry] of textIndex.entries()) {
                if (indexEntry.text.includes(searchTermLower)) results.push(indexEntry);
            }
            return results;
        }

        async function loadCSVData() {
            try {
                const response = await fetch('vkrn.csv');
                const csvText = await response.text();
                const lines = csvText.split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                for (let i = 1; i < lines.length; i++) {
                    const currentLine = lines[i].split(',');
                    if (currentLine.length === headers.length && currentLine[0].trim() !== '') {
                        const obj = {};
                        for (let j = 0; j < headers.length; j++) {
                            obj[headers[j]] = currentLine[j].trim();
                        }
                        csvData.push(obj);
                    }
                }
            } catch (error) { throw error; }
        }

        function displayResults(results) {
            const resultsContainer = document.getElementById('resultsContainer');
            if (results.length === 0) {
                resultsContainer.innerHTML = '<div class="no-results">Tidak ditemukan data yang sesuai</div>';
                return;
            }
            let html = `<div class="results-count">üìä Ditemukan ${results.length} data:</div>`;
            results.forEach((item, index) => {
                html += '<div class="result-item">';
                for (const key in item) {
                    html += `<p><strong>${key}:</strong> ${item[key]}</p>`;
                }
                html += '</div>';
            });
            resultsContainer.innerHTML = html;
        }

        // SEARCH
        document.getElementById('searchButton').onclick = function () {
            const keyword = document.getElementById('searchInput').value;
            if (keyword.trim() === "") return alert('Silakan masukkan kata kunci pencarian');
            if (!isSystemReady) return alert('Sistem belum siap. Klik refresh database terlebih dahulu.');
            const results = csvData.filter(item => {
                for (const key in item) {
                    if (item[key].toLowerCase().includes(keyword.toLowerCase())) return true;
                }
                return false;
            });
            displayResults(results);
        };

        // REFRESH BUTTON
        document.getElementById('refreshDbBtn').onclick = refreshDatabase;

        // INIT
        window.onload = initializeSystem;
    </script>
</body>
    </html>
